# Coveralls Test Coverage Setup

This document explains how to set up and use Coveralls for test coverage reporting in the industry-tool project.

## What is Coveralls?

Coveralls is a web service that helps you track code coverage over time and ensures that all new code is covered by tests. It integrates with GitHub to provide coverage reports on pull requests.

## Initial Setup

### 1. Enable Coveralls for Your Repository

1. Go to [Coveralls.io](https://coveralls.io/)
2. Sign in with your GitHub account
3. Click "Add Repos"
4. Find `industry-tool` and toggle it on
5. No additional configuration needed - the repository is now enabled

### 2. Update README Badges

Replace `YOUR_USERNAME` in README.md with your actual GitHub username:

```markdown
[![Coverage Status](https://coveralls.io/repos/github/YOUR_USERNAME/industry-tool/badge.svg?branch=main)](https://coveralls.io/github/YOUR_USERNAME/industry-tool?branch=main)
```

## How It Works

### GitHub Actions Workflow

The CI workflow (`.github/workflows/ci.yml`) automatically:

1. **Runs Backend Tests**
   - Executes Go tests with coverage
   - Generates `coverage.out` file
   - Uploads coverage to Coveralls with `flag-name: backend`

2. **Runs Frontend Tests**
   - Executes Jest tests with coverage
   - Generates `lcov.info` file
   - Uploads coverage to Coveralls with `flag-name: frontend`

3. **Finalizes Coverage Report**
   - Combines backend and frontend coverage
   - Posts coverage report to PR (if applicable)
   - Updates coverage badge

### Coverage Files

**Backend (Go):**
- Format: Go coverage format (`.out`)
- Location: `artifacts/coverage/backend/coverage.out`
- Generated by: `go test -coverprofile`

**Frontend (JavaScript/TypeScript):**
- Format: LCOV format (`.info`)
- Location: `artifacts/coverage/frontend/lcov.info`
- Generated by: Jest with `--coverage`

## Workflow Configuration

### Backend Coverage Upload

```yaml
- name: Upload backend coverage to Coveralls
  uses: coverallsapp/github-action@v2
  if: success()
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    path-to-lcov: artifacts/coverage/backend/coverage.out
    flag-name: backend
    parallel: true
    format: golang
```

**Key Parameters:**
- `path-to-lcov`: Path to coverage file
- `flag-name`: Identifier for this coverage source
- `parallel: true`: Allows multiple coverage uploads
- `format: golang`: Specifies Go coverage format

### Frontend Coverage Upload

```yaml
- name: Upload frontend coverage to Coveralls
  uses: coverallsapp/github-action@v2
  if: success()
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    path-to-lcov: artifacts/coverage/frontend/lcov.info
    flag-name: frontend
    parallel: true
    base-path: frontend
```

**Key Parameters:**
- `path-to-lcov`: Path to lcov.info file
- `flag-name`: Identifier for this coverage source
- `parallel: true`: Allows multiple coverage uploads
- `base-path: frontend`: Maps file paths relative to frontend directory
- No `format` needed (LCOV is default)

### Finalization Step

```yaml
- name: Finalize Coveralls parallel build
  uses: coverallsapp/github-action@v2
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    parallel-finished: true
```

This step tells Coveralls that all parallel uploads are complete and it should process the combined coverage report.

## Viewing Coverage Reports

### On Pull Requests

Coveralls automatically comments on PRs with:
- Overall coverage percentage
- Coverage change from base branch
- Detailed file-by-file breakdown
- Warning if coverage decreases

### On Coveralls Website

1. Go to https://coveralls.io/github/YOUR_USERNAME/industry-tool
2. View:
   - Overall coverage percentage
   - Coverage trends over time
   - File-by-file coverage
   - Separate backend and frontend coverage (via flags)

### Locally

**Backend:**
```bash
make test-backend
open artifacts/coverage/backend/coverage.html
```

**Frontend:**
```bash
make test-frontend
open artifacts/coverage/frontend/lcov-report/index.html
```

## Coverage Flags

The project uses two coverage flags to separate backend and frontend:

- **`backend`**: Go test coverage
- **`frontend`**: JavaScript/TypeScript test coverage

This allows you to:
- View combined coverage
- View backend coverage separately
- View frontend coverage separately
- Set different coverage requirements for each

## Troubleshooting

### Coverage Not Uploading

**Check:**
1. Tests are passing (coverage only uploads on success)
2. Coverage files are being generated
3. File paths match in workflow and actual artifacts
4. Repository is enabled on Coveralls

**Debug:**
```bash
# Check if coverage files exist
ls -la artifacts/coverage/backend/coverage.out
ls -la artifacts/coverage/frontend/lcov.info
```

### Coverage Badge Not Updating

**Possible Causes:**
1. Badge cache (wait a few minutes)
2. Incorrect GitHub username in badge URL
3. Repository not enabled on Coveralls
4. Coverage upload failed silently

**Fix:**
- Hard refresh browser (Ctrl+Shift+R / Cmd+Shift+R)
- Check Coveralls build logs
- Verify repository is enabled

### Different Coverage Locally vs CI

**This is normal** if:
- Local tests run different subset
- Coverage calculation differs slightly
- File paths differ between local and CI

**Solutions:**
- Always check CI coverage as source of truth
- Run full test suite locally: `make test-all`
- Compare coverage files to identify differences

## Best Practices

### Coverage Goals

**Current Coverage Levels:**
- Backend: ~85% (aim for 80%+ on new code)
- Frontend: ~70% (aim for 75%+ on new code)

### Writing Testable Code

1. **Unit Tests First**: Write unit tests for all new code
2. **Test Edge Cases**: Cover error paths and edge cases
3. **Mock External Dependencies**: Use mocks for ESI API, database
4. **Integration Tests**: Add integration tests for critical paths

### PR Coverage Checks

Coveralls will:
- ✅ Pass: If coverage increases or stays the same
- ⚠️ Warn: If coverage decreases slightly (< 1%)
- ❌ Fail: If coverage decreases significantly (configurable)

**Note**: Coverage failures are warnings only - they don't block PRs automatically. But reviewers should check why coverage decreased.

## Configuration Files

### Coveralls Configuration (Optional)

Create `.coveralls.yml` in project root if you need custom settings:

```yaml
# Optional - most settings are in GitHub Actions
service_name: github-actions
repo_token: # Not needed with GitHub Actions

# Flag configuration (optional)
coverage_flags:
  backend:
    name: Backend
    paths:
      - internal/
  frontend:
    name: Frontend
    paths:
      - frontend/packages/
```

### GitHub Actions Secrets

**No secrets needed!** The workflow uses:
- `secrets.GITHUB_TOKEN` - Automatically provided by GitHub
- No COVERALLS_REPO_TOKEN needed for public repos

For private repositories, add `COVERALLS_REPO_TOKEN` to GitHub secrets.

## Maintenance

### Updating Coveralls Action

The workflow uses `coverallsapp/github-action@v2`. To update:

```bash
# Check for new version
# https://github.com/coverallsapp/github-action/releases

# Update in .github/workflows/ci.yml
uses: coverallsapp/github-action@v2  # Update version number
```

### Coverage Thresholds

To enforce minimum coverage:

```yaml
# Add to Coveralls settings (web UI)
# Or add to CI workflow:
- name: Check coverage threshold
  run: |
    COVERAGE=$(go tool cover -func=artifacts/coverage/backend/coverage.out | grep total | awk '{print $3}' | sed 's/%//')
    if (( $(echo "$COVERAGE < 80" | bc -l) )); then
      echo "❌ Coverage $COVERAGE% is below 80%"
      exit 1
    fi
```

## Additional Resources

- **Coveralls Documentation**: https://docs.coveralls.io/
- **GitHub Action**: https://github.com/coverallsapp/github-action
- **Go Coverage**: https://go.dev/blog/cover
- **Jest Coverage**: https://jestjs.io/docs/configuration#collectcoverage-boolean

## Support

If you encounter issues with Coveralls:

1. Check [Coveralls Status](https://status.coveralls.io/)
2. Review [Coveralls Documentation](https://docs.coveralls.io/)
3. File issue on [GitHub Action repo](https://github.com/coverallsapp/github-action/issues)
4. Contact Coveralls support at support@coveralls.io

---

**Last Updated**: 2026-02-14
**Workflow Version**: CI v1.1 (with Coveralls)
